---
title: Виклики між програмами (CPI)
sidebarLabel: Виклики між програмами
sidebarSortOrder: 6
description:
  Дізнайтеся про виклики між програмами (CPI) у Solana - як програми можуть
  викликати інструкції інших програм, обробляти підписантів PDA і складати
  функціональність у мережі Solana.
---

Виклик між програмами (CPI) відбувається, коли одна програма викликає інструкції
іншої програми. Цей механізм дозволяє складати програми Solana.

Інструкції можна уявити як API-методи, які програма надає мережі, а CPI - це
виклик одного API-методу іншим API-методом.

![Виклик між програмами](/assets/docs/core/cpi/cpi.svg)

Коли програма ініціює виклик між програмами (CPI) до іншої програми:

- Привілеї підпису від початкової транзакції, що викликає програму (A),
  розширюються на програму-отримувача (B).
- Програма-отримувач (B) може здійснювати подальші CPI до інших програм до
  максимального рівня глибини 4 (наприклад, B->C, C->D).
- Програми можуть "підписувати" від імені [PDA](/docs/core/pda.md), що створені
  з їхнього ID програми.

> У середовищі виконання програм Solana визначено константу під назвою
> [`max_invoke_stack_height`](https://github.com/solana-labs/solana/blob/27eff8408b7223bb3c4ab70523f8a8dca3ca6645/program-runtime/src/compute_budget.rs#L31-L35),
> яка має значення
> [5](https://github.com/solana-labs/solana/blob/27eff8408b7223bb3c4ab70523f8a8dca3ca6645/program-runtime/src/compute_budget.rs#L138).
> Це обмеження встановлює максимальну висоту стеку викликів інструкцій програми.
> Висота стеку починається з 1 для інструкцій транзакції, збільшується на 1
> кожного разу, коли програма викликає іншу інструкцію. Це ефективно обмежує
> глибину викликів для CPI до 4.

## Основні моменти

- CPI дозволяє інструкціям програми Solana безпосередньо викликати інструкції
  іншої програми.

- Привілеї підпису від програми-виклику розширюються на програму-отримувача.

- Під час здійснення CPI програми можуть "підписувати" від імені PDA, створених
  із їхнього власного ID програми.

- Програма-отримувач може здійснювати додаткові CPI до інших програм до
  максимальної глибини 4.

## Як написати CPI

Написання інструкції для CPI слідує тій самій схемі, що й побудова
[інструкції](/docs/core/transactions.md#instruction) для додавання до
транзакції. Кожна інструкція CPI повинна зазначати таку інформацію:

- **Адреса програми**: Вказує програму, яка викликається
- **Облікові записи**: Перераховує кожен обліковий запис, з якого інструкція
  читає або в який записує, включаючи інші програми
- **Дані інструкції**: Вказує, яку інструкцію у програмі викликати, а також
  будь-які додаткові дані, необхідні для інструкції (аргументи функції)

Залежно від програми, до якої здійснюється виклик, можуть бути доступні crates
із допоміжними функціями для створення інструкції. Програми потім виконують CPI
за допомогою однієї з наступних функцій з crate `solana_program`:

- `invoke` - використовується, коли немає підписантів PDA
- `invoke_signed` - використовується, коли програма-викликач повинна підписати
  за допомогою PDA, створеного з її ID програми

### Базовий CPI

Функція
[`invoke`](https://github.com/solana-labs/solana/blob/27eff8408b7223bb3c4ab70523f8a8dca3ca6645/sdk/program/src/program.rs#L132)
використовується під час здійснення CPI, який не потребує підписантів PDA. Під
час здійснення CPI підписанти, надані програмі-виклику, автоматично розширюються
на програму-отримувача.

```rust
pub fn invoke(
    instruction: &Instruction,
    account_infos: &[AccountInfo<'_>]
) -> Result<(), ProgramError>
```

Ось приклад програми на
[Solana Playground](https://beta.solpg.io/github.com/ZYJLiu/doc-examples/tree/main/cpi-invoke),
яка здійснює CPI за допомогою функції `invoke` для виклику інструкції передачі в
Системній Програмі. Ви також можете ознайомитися з
[Базовим посібником CPI](/content/guides/getstarted/how-to-cpi.md) для
додаткової інформації.

### CPI з підписантом PDA

Функція
[`invoke_signed`](https://github.com/solana-labs/solana/blob/27eff8408b7223bb3c4ab70523f8a8dca3ca6645/sdk/program/src/program.rs#L247)
використовується під час здійснення CPI, який потребує підписантів PDA. Насіння,
що використовується для створення підписаних PDA, передається у функцію
`invoke_signed` як `signer_seeds`.

Ви можете ознайомитися з сторінкою
[Програмно Створені Адреси (PDA)](/docs/core/pda.md) для деталей про те, як PDA
створюються.

```rust
pub fn invoke_signed(
    instruction: &Instruction,
    account_infos: &[AccountInfo<'_>],
    signers_seeds: &[&[&[u8]]]
) -> Result<(), ProgramError>
```

Середовище виконання використовує привілеї, надані програмі-виклику, щоб
визначити, які привілеї можуть бути розширені на програму-отримувача. У цьому
контексті привілеї стосуються підписантів і облікових записів із правом запису.
Наприклад, якщо інструкція, яку обробляє програма-викликач, містить підписанта
або обліковий запис із правом запису, то програма-викликач може викликати
інструкцію, яка також містить цього підписанта та/або обліковий запис із правом
запису.

Хоча PDA не мають [приватних ключів](/docs/core/pda.md#what-is-a-pda), вони все
одно можуть діяти як підписант в інструкції через CPI. Щоб підтвердити, що PDA
створений із програми, що викликає, необхідно включити насіння, використане для
створення PDA, як `signers_seeds`.

Коли CPI обробляється, середовище виконання Solana
[викликає внутрішньо `create_program_address`](https://github.com/solana-labs/solana/blob/27eff8408b7223bb3c4ab70523f8a8dca3ca6645/programs/bpf_loader/src/syscalls/cpi.rs#L550)
за допомогою `signers_seeds` і `program_id` програми-виклику. Якщо виявлено
дійсний PDA, адресу додають
[як дійсного підписанта](https://github.com/solana-labs/solana/blob/27eff8408b7223bb3c4ab70523f8a8dca3ca6645/programs/bpf_loader/src/syscalls/cpi.rs#L552).

Ось приклад програми на
[Solana Playground](https://beta.solpg.io/github.com/ZYJLiu/doc-examples/tree/main/cpi-invoke-signed),
яка здійснює CPI за допомогою функції `invoke_signed` для виклику інструкції
передачі в Системній Програмі з підписантом PDA. Ви можете ознайомитися з
[Посібником CPI з підписантом PDA](/content/guides/getstarted/how-to-cpi-with-signer.md)
для додаткової інформації.
